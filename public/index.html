app.post('/api/sensor-data', (req, res) => {
  const body = req.body;
  const payload = body.payload;
  const deviceMetaData = body.payloadMetaData?.deviceMetaData || {};

  const orcaDeviceEUIs = [
    "647FDA000001B8B8",
    "647FDA000001B886"
  ];

  let bytes = payload.bytes;
  if (typeof bytes === 'string') {
    try {
      bytes = JSON.parse(bytes);
    } catch (e) {
      return res.status(400).send('Invalid byte string format');
    }
  }
  const convertedBytes = bytes.map(b => (b < 0 ? b + 256 : b));

  const deviceEUI = deviceMetaData.deviceEUI || 'unknown_device';
  const deviceName = deviceMetaData.name || `ID: ${deviceEUI}`;

  let decodedData;
  if (orcaDeviceEUIs.includes(deviceEUI)) {
    decodedData = decodeUplinkOrca({ bytes: convertedBytes, fPort: payload.port });
  } else {
    decodedData = decodeUplinkSeal({ bytes: convertedBytes, fPort: payload.port });
  }

  latestSensorData = decodedData.data;

  if (!allSensorsData[deviceEUI]) allSensorsData[deviceEUI] = {};
  allSensorsData[deviceEUI].name = deviceName;
  Object.assign(allSensorsData[deviceEUI], decodedData.data);

  if (decodedData.data.acceleration_vector) {
    allSensorsData[deviceEUI].acceleration_vector = {
      ...allSensorsData[deviceEUI].acceleration_vector,
      ...decodedData.data.acceleration_vector
    };
  }
  if (decodedData.data.safety_status) {
    allSensorsData[deviceEUI].safety_status = {
      ...allSensorsData[deviceEUI].safety_status,
      ...decodedData.data.safety_status
    };
  }
  if (decodedData.data.coordinates) {
    allSensorsData[deviceEUI].coordinates = {
      ...allSensorsData[deviceEUI].coordinates,
      ...decodedData.data.coordinates
    };
  }

  res.status(200).send('OK');
});
